# 4. 具体实现

本章节介绍混合PQC TLS握手协议的性能基准测试框架的设计与实现。

## 4.1 测试框架整体架构

性能基准测试框架采用**模块化分层设计**，包含四个核心模块：

1. **算法层测试**（`benchmark_key_exchange`、`benchmark_signature`）：测量KEM和签名算法的原始性能
2. **协议层测试**（`benchmark_handshake`）：测量完整TLS握手流程的端到端性能
3. **网络层测试**（`benchmark_complete_handshake_with_network`）：模拟真实网络环境的握手性能
4. **批量测试与可视化**（`batch_benchmark_and_visualize.py`）：自动化测试执行和结果可视化

测试框架支持**超级并行模式**（`run_benchmarks_ultra_parallel.py`），在多核CPU上同时执行所有测试任务，相比串行测试可实现**8-12倍加速**。

## 4.2 算法性能测试

### 4.2.1 密钥交换算法测试

`benchmark_key_exchange()`方法模拟完整的密钥协商过程：客户端生成密钥对并发送公钥，服务器生成密钥对并计算共享密钥，最后客户端计算共享密钥。使用高精度计时器（`time.perf_counter()`）测量整个双向交换过程，并记录客户端和服务器公钥的大小用于消息长度分析。每个算法默认执行100次迭代，计算平均时间和吞吐量。

测试覆盖算法包括：
- **纯PQC算法**：Kyber512/768/1024（NIST Level 1/3/5）、NTRU-HPS-2048-509/677（Level 1/3）
- **混合算法**：P-256+Kyber512/768、P-384+Kyber768、P-256+NTRU-HPS-2048-509、P-384+NTRU-HPS-2048-677

### 4.2.2 数字签名算法测试

`benchmark_signature()`方法测量完整的签名生成和验证流程：生成签名密钥对，对测试消息进行签名，然后验证签名的正确性。测试记录签名大小和公钥大小，用于后续证书大小估算。

测试覆盖算法：ML-DSA-44/65/87（Level 2/3/5）、Falcon-512/1024（Level 1/5）。

## 4.3 完整握手性能测试

`benchmark_handshake()`方法模拟真实的TLS 1.3握手流程，包含四个关键步骤：

1. **ClientHello生成**：客户端根据TLS模式选择KEM算法，生成ClientHello消息
2. **ServerHello处理**：服务器处理ClientHello，完成密钥交换并生成ServerHello
3. **证书签名**：服务器加载证书链（服务器证书+中间CA证书），计算握手哈希并生成CertificateVerify签名
4. **证书验证**：客户端验证完整证书链和握手签名

测试记录所有握手消息的大小，包括ClientHello、ServerHello和Certificate的长度。支持三种TLS模式：Classic（X25519+ECDSA）、PQC（Kyber768+ML-DSA-65）、Hybrid（P-256+Kyber768+ML-DSA-65）。

**证书管理设计**：框架通过`CERTIFICATE_CHAIN_PATHS`字典自动管理不同算法的证书路径。经典算法（ECDSA）的签名直接存储在`.crt`文件中，而PQC算法需要额外的`.sig`文件存储后量子签名。

## 4.4 网络感知性能测试

### 4.4.1 网络延迟模型

`NetworkConfig`类定义了网络延迟的数学模型，包含两种延迟成分：

- **传输延迟**（Transmission Delay）：\( T_{trans} = \frac{L \times 8}{R} \)
  - L：数据大小（字节），R：传输速率（bps）
  - 反映数据在网络中的实际传输时间
  
- **传播延迟**（Propagation Delay）：\( T_{prop} = \frac{d}{v} \)
  - d：物理距离（km），v：光速（简化为200,000 km/s）
  - 反映信号在物理介质中的传播时间

- **总延迟**：\( T_{total} = T_{trans} + T_{prop} \)

模型提供多种预定义配置：传输速率包括localhost（1Gbps）、lan（100Mbps）、fast_wan（10Mbps）；距离包括local（0.1km）、city（10km）、country（2000km）。

### 4.4.2 网络感知握手测试

`benchmark_complete_handshake_with_network()`方法在标准握手测试基础上，通过`NetworkSimulator`类在每个握手消息传输后插入网络延迟模拟。模拟器使用`sleep()`函数根据消息大小和网络配置计算延迟时间，精确模拟实际传输过程。测试分别记录纯计算时间和网络延迟时间，用于分析网络对握手性能的影响。

## 4.5 超级并行测试系统

`run_ultra_parallel_benchmarks()`方法实现了极致的并行测试策略：使用`ThreadPoolExecutor`创建与CPU核心数相匹配的线程池（通常为核心数-1），同时提交所有测试任务（10个KEM算法+5个签名算法+3种握手模式）。

并行执行流程：
1. 通过`executor.submit()`提交所有测试任务到线程池
2. 使用`as_completed()`迭代器实时收集完成的任务结果
3. 实时显示测试进度和完成状态
4. 将所有测试结果合并为统一的JSON文件

**性能优势**：在16核CPU上，comprehensive测试（100次迭代×18个测试）仅需约140秒，而串行执行需要约20分钟。

## 4.6 批量测试与可视化

### 4.6.1 测试场景配置

`batch_benchmark_and_visualize.py`脚本定义了多种预配置测试场景：
- **quick**：1次迭代，用于功能验证（~5秒）
- **standard**：10次迭代，用于日常评估（~15秒）
- **comprehensive**：100次迭代，用于论文数据（~140秒）
- **network_only**：专项网络影响分析（5-10分钟）
- **kex_only/sig_only**：单一算法类型的深度测试

### 4.6.2 自动化可视化

测试完成后，`visualize_scenario_results()`方法自动生成多种PDF格式图表：
1. **KEM算法性能对比图**：按安全等级分组，包含吞吐量、平均时间、公钥大小三个子图
2. **签名算法性能对比图**：包含吞吐量、平均时间、证书大小三个子图
3. **握手性能对比图**：2×2布局，包含吞吐量、平均时间、消息长度分布（堆叠柱状图）、证书大小对比
4. **网络影响分析图**：标注传输速率、距离参数和延迟计算公式
5. **综合对比图**：所有测试结果的全面对比

可视化设计使用安全等级颜色编码，添加垂直分隔线区分不同安全等级组，自动调整Y轴范围避免标签重叠，适合学术论文插图。

## 4.7 实现总结

测试框架的核心特点：
1. **模块化设计**：算法层、协议层、网络层清晰分离，易于扩展
2. **网络感知**：创新的网络延迟模拟系统，精确模拟传输和传播延迟
3. **高度并行**：超级并行模式充分利用多核CPU，实现8-12倍加速
4. **自动化**：从测试执行到结果可视化全自动化，减少人工干预
5. **论文友好**：直接生成PDF格式图表，数据格式适合学术出版

该测试框架为第5章的实验结果分析提供了可靠的数据基础和丰富的可视化支持。

# 浏览器访问和抓包验证指南

## 核心步骤（5步）

1. **启动后端服务器** → 端口8443，使用自定义TLS
2. **启动代理服务器** → 端口8080，协议转换
3. **配置浏览器代理** → 127.0.0.1:8080
4. **启动Wireshark抓包** → 过滤端口8443
5. **浏览器访问** → https://127.0.0.1:8443

---

## 详细步骤

### 步骤1: 启动后端HTTPS服务器

**终端1** - 启动后端服务器：

```bash
cd D:\Coding\Project\TLS_Hybrid\Hybrid_PQC_TLS_Lab\Hybrid_PQC_TLS_Lab
python implementation/enhanced_v2/https_server.py --port 8443 --mode hybrid
```

**预期输出**：
```
======================================================================
  混合PQC-TLS HTTPS服务器
======================================================================
  地址: https://0.0.0.0:8443
  模式: hybrid
======================================================================

[HTTPS] 服务器监听在 0.0.0.0:8443
[HTTPS] 等待连接...
```

**说明**：
- 后端服务器使用自定义混合TLS协议
- 监听8443端口
- 等待客户端连接

---

### 步骤2: 启动HTTPS代理服务器

**终端2** - 启动代理服务器：

```bash
python implementation/enhanced_v2/https_proxy.py \
    --proxy-port 8080 \
    --backend-host 127.0.0.1 \
    --backend-port 8443 \
    --mode hybrid
```

**预期输出**：
```
======================================================================
  HTTPS代理服务器
======================================================================
  代理地址: http://0.0.0.0:8080
  后端地址: 127.0.0.1:8443
  模式: hybrid
======================================================================

[*] 代理服务器启动中...
[*] 浏览器设置代理: 0.0.0.0:8080
[*] 访问: https://127.0.0.1:8443
```

**说明**：
- 代理服务器监听8080端口
- 接收浏览器的标准HTTPS请求
- 转换为自定义TLS协议后转发到后端

---

### 步骤3: 配置浏览器代理

#### Chrome/Edge浏览器

1. **打开设置**
   - Chrome: 右上角三点菜单 → 设置
   - Edge: 右上角三点菜单 → 设置

2. **进入代理设置**
   - 搜索"代理"或"proxy"
   - 点击"打开计算机的代理设置"（Windows）
   - 或直接访问：`chrome://settings/system` → 打开计算机的代理设置

3. **配置代理**
   - 打开"使用代理服务器"
   - 地址：`127.0.0.1`
   - 端口：`8080`
   - 保存

#### Firefox浏览器

1. **打开设置**
   - 右上角菜单 → 设置

2. **网络设置**
   - 滚动到底部 → 网络设置 → 设置

3. **配置代理**
   - 选择"手动代理配置"
   - HTTP代理：`127.0.0.1`，端口：`8080`
   - HTTPS代理：`127.0.0.1`，端口：`8080`
   - 保存

#### 验证代理配置

访问 http://httpbin.org/ip 查看IP，确认代理生效。

---

### 步骤4: 启动Wireshark抓包

1. **启动Wireshark**
   - 打开Wireshark应用程序

2. **选择网络接口（⚠️ 关键步骤！）**
   
   **Windows系统**：
   - ⭐ **必须选择**：`Loopback: Loopback` 或 `Adapter for loopback traffic capture`
   - 这是捕获本地回环（127.0.0.1）流量的接口
   - ⚠️ **不要选择** `以太网` 或 `Wi-Fi`（那些是外部网络流量）
   
   **如果看不到Loopback接口**：
   - Windows需要安装 **Npcap**（不是WinPcap）
   - 下载：https://npcap.com/
   - 安装时选择 "Install Npcap in WinPcap API-compatible Mode"
   - 安装后重启Wireshark

3. **设置过滤规则**
   
   **推荐过滤器**（只显示实验相关流量）：
   ```
   (tcp.port == 8443 or tcp.port == 8080) and ip.addr == 127.0.0.1
   ```
   
   **或者更简单的**（如果只选择了Loopback接口）：
   ```
   tcp.port == 8443 or tcp.port == 8080
   ```
   
   **如果还是看不到包，尝试最宽泛的过滤器**：
   ```
   ip.addr == 127.0.0.1
   ```
   这会显示所有本地回环流量，然后手动查找8443和8080端口

4. **开始抓包**
   - 点击"开始捕获分组"（绿色鲨鱼图标）
   - 确保选择了Loopback接口
   - 在浏览器中访问 `https://pqc-tls.local:8443`
   - 应该立即看到数据包出现

**说明**：
- 过滤8443端口可以看到后端服务器的通信
- 过滤8080端口可以看到浏览器和代理的通信
- ⚠️ **重要**：必须选择正确的网络接口！

**正确的Wireshark设置**：

1. **选择网络接口**：
   - Windows: 选择 **"Loopback: Loopback"** 或 **"Adapter for loopback traffic capture"**
   - 这是捕获本地回环（127.0.0.1）流量的接口
   - ⚠️ **不要选择** 以太网或WiFi接口（那些是外部网络流量）

2. **过滤器设置**：
   ```
   (tcp.port == 8443 or tcp.port == 8080) and ip.addr == 127.0.0.1
   ```
   
   或者更简单的：
   ```
   tcp.port == 8443 or tcp.port == 8080
   ```
   （如果只选择了Loopback接口，所有流量都是127.0.0.1的）

3. **如果看不到Loopback接口**：
   - Windows: 需要安装 **Npcap**（不是WinPcap）
   - 下载地址：https://npcap.com/
   - 安装时选择"Install Npcap in WinPcap API-compatible Mode"

4. **验证过滤器是否生效**：
   - 在浏览器中访问 `https://pqc-tls.local:8443`
   - 应该能看到数据包出现
   - 如果还是没有，尝试更宽泛的过滤器：`ip.addr == 127.0.0.1`

---

### 步骤5: 配置 hosts 文件（重要！）

**为什么需要这一步？**
- 某些浏览器会绕过 `127.0.0.1` 和 `localhost` 的代理
- 使用域名可以强制浏览器通过代理访问

1. **编辑 hosts 文件**
   - Windows: `C:\Windows\System32\drivers\etc\hosts`
   - 需要管理员权限

2. **添加映射**
   ```
   127.0.0.1 pqc-tls.local
   ```

3. **保存文件**
   - 如果无法保存，请以管理员身份运行记事本

### 步骤6: 浏览器访问网站

1. **打开浏览器**
   - 确保已配置代理（步骤3）

2. **访问网站**
   - 地址栏输入：`https://pqc-tls.local:8443`
   - ⚠️ **不要使用** `https://127.0.0.1:8443`（浏览器会绕过代理）

3. **处理证书警告**
   - 浏览器会显示"您的连接不是私密连接"
   - 点击"高级" → "继续前往 pqc-tls.local（不安全）"
   - 这是正常的（使用自定义证书）

4. **查看网页**
   - 应该能看到"混合PQC-TLS HTTPS演示"页面
   - 显示TLS连接信息和安全特性

---

## 抓包验证要点

### 在Wireshark中观察

#### 1. TLS握手阶段（端口8443）

**ClientHello**：
- 可以看到客户端发送的握手消息
- 包含支持的密码套件和签名算法

**ServerHello**：
- 服务器响应的握手消息
- 可以看到协商的算法

**Certificate消息**：
- 服务器发送的证书链
- 可以看到后量子证书数据

**CertificateVerify**：
- 服务器签名验证
- 可以看到后量子签名（ML-DSA-65等，签名较大）

#### 2. 应用数据阶段

**加密的HTTP请求**：
- 可以看到加密的数据包
- 无法直接看到明文（除非有密钥）

**加密的HTTP响应**：
- 服务器返回的加密响应
- 数据包大小会因后量子签名而增大

#### 3. 数据包特征

**后量子算法特征**：
- 签名大小：ML-DSA-65约3309字节，ML-DSA-87约4627字节
- 密钥交换：可以看到Kyber密钥交换数据
- 证书链：包含后量子扩展信息

---

## 验证清单

- [ ] 后端服务器启动成功，显示"等待连接"
- [ ] 代理服务器启动成功，显示"代理服务器启动中"
- [ ] 浏览器代理配置正确
- [ ] Wireshark开始抓包，显示数据包
- [ ] 浏览器能访问网站，显示HTTPS页面
- [ ] Wireshark能看到TLS握手消息
- [ ] Wireshark能看到加密的应用数据包
- [ ] 数据包大小符合后量子算法特征（签名较大）

---

## 常见问题

### Q1: 浏览器无法连接

**检查**：
1. 后端服务器是否启动（终端1）
2. 代理服务器是否启动（终端2）
3. 浏览器代理配置是否正确
4. 防火墙是否阻止连接

**解决**：
```bash
# 检查端口是否被占用
netstat -an | findstr "8443"
netstat -an | findstr "8080"
```

### Q2: Wireshark看不到数据包

**检查**：
1. 是否选择了正确的网络接口（Loopback）
2. 过滤规则是否正确
3. 是否在访问网站后才开始抓包

**解决**：
- 尝试不设置过滤，查看所有数据包
- 确认访问了网站（步骤5）

### Q3: 证书警告

**说明**：
- 这是正常的，因为我们使用自定义证书
- 浏览器不信任自定义CA证书
- 点击"高级" → "继续访问"即可

### Q4: 代理连接失败

**检查**：
1. 代理服务器是否正常运行
2. 端口8080是否被占用
3. 浏览器代理配置是否正确

**解决**：
```bash
# 测试代理连接
curl -x http://127.0.0.1:8080 https://127.0.0.1:8443
```

---

## 完整示例命令

**终端1 - 后端服务器**：
```bash
python implementation/enhanced_v2/https_server.py --port 8443 --mode hybrid --algorithm mldsa65
```

**终端2 - 代理服务器**：
```bash
python implementation/enhanced_v2/https_proxy.py --proxy-port 8080 --backend-port 8443 --mode hybrid
```

**终端3 - 测试客户端（可选）**：
```bash
python implementation/enhanced_v2/enhanced_client.py --host 127.0.0.1 --port 8443 --mode hybrid
```

**浏览器**：
- 设置代理：127.0.0.1:8080
- 访问：https://127.0.0.1:8443

**Wireshark**：
- 过滤：`tcp.port == 8443 or tcp.port == 8080`
- 开始抓包

---

## 预期结果

### 浏览器中
- ✅ 成功访问HTTPS网站
- ✅ 显示"混合PQC-TLS HTTPS演示"页面
- ✅ 显示TLS连接信息（ML-DSA-65等）

### Wireshark中
- ✅ 看到TLS握手消息（ClientHello, ServerHello等）
- ✅ 看到加密的应用数据包
- ✅ 数据包大小符合后量子算法特征
- ✅ 可以看到后量子签名（较大的数据包）

### 服务器日志中
- ✅ TLS握手成功
- ✅ HTTP请求和响应
- ✅ 加密/解密成功

---

## 下一步

成功验证后，可以：
1. 分析Wireshark中的数据包结构
2. 对比传统TLS和后量子TLS的数据包大小
3. 测试不同的签名算法（mldsa44, mldsa87, falcon512等）
4. 分析性能差异

